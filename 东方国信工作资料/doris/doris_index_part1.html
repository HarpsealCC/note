<!DOCTYPE html><html><head>
      <title>doris_index_part1</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/lcz/.vscode-server/extensions/shd101wyy.markdown-preview-enhanced-0.8.11/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<ul>
<li><a href="#doris-index%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%88%86%E6%9E%90">Doris Index介绍与分析</a>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#segment%E5%82%A8%E5%AD%98%E6%A0%BC%E5%BC%8F%E4%B8%8Eindex%E7%9A%84%E5%85%B3%E7%B3%BB">segment储存格式与index的关系</a></li>
<li><a href="#segment%E8%AF%BB%E5%86%99%E9%80%BB%E8%BE%91%E4%B8%8Eindex%E8%AF%BB%E5%86%99%E9%80%BB%E8%BE%91%E7%9A%84%E5%85%B3%E7%B3%BB%E7%AE%80%E4%BB%8B">segment读写逻辑与index读写逻辑的关系简介</a>
<ul>
<li><a href="#index%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B">index的写入流程</a></li>
<li><a href="#%E6%A8%A1%E5%9D%97%E5%85%B3%E7%B3%BB">模块关系</a></li>
<li><a href="#index%E7%9A%84%E8%AF%BB%E5%8F%96%E6%B5%81%E7%A8%8B">index的读取流程</a></li>
<li><a href="#%E6%A8%A1%E5%9D%97%E5%85%B3%E7%B3%BB-1">模块关系</a></li>
</ul>
</li>
<li><a href="#%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D">索引介绍</a>
<ul>
<li><a href="#ordinal-%E7%B4%A2%E5%BC%95">Ordinal 索引</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0">索引概述</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E7%94%9F%E6%88%90">索引生成</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E8%AF%BB%E5%8F%96">索引读取</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8">索引使用</a></li>
</ul>
</li>
<li><a href="#zone-map-%E7%B4%A2%E5%BC%95">Zone Map 索引</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0-1">索引概述</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E7%94%9F%E6%88%90-1">索引生成</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E8%AF%BB%E5%8F%96-1">索引读取</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8-1">索引使用</a></li>
</ul>
</li>
<li><a href="#%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95short-key-index">前缀索引（Short Key Index）</a>
<ul>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0-2">索引概述</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E7%94%9F%E6%88%90-2">索引生成</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E8%AF%BB%E5%8F%96-2">索引读取</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8-2">索引使用</a></li>
</ul>
</li>
<li><a href="#bitmap-%E7%B4%A2%E5%BC%95">Bitmap 索引</a></li>
<li><a href="#bloom-filter-%E7%B4%A2%E5%BC%95">Bloom Filter 索引</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
</li>
</ul>
<h1 id="doris-index介绍与分析">Doris Index介绍与分析 </h1>
<h2 id="概述">概述 </h2>
<p>为了提高数据读取效率，Apache Doris 底层存储引擎提供了丰富的索引类型。分别是<strong>前缀索引（Short Key Index）</strong>、<strong>Ordinal 索引</strong>、<strong>Zone Map索引</strong>、<strong>Bitmap 索引</strong>、<strong>Bloom Filter 索引与Ngram Bloomfilter索引</strong>和<strong>倒排索引（inverted index）</strong>。<br>
其中前缀索引、Ordinal 索引和 Zone Map 索引不需要用户干预，会随着数据写入自动生成，也有资料称这些索引为<strong>内建的智能索引</strong><br>
Bitmap 索引和 Bloom Filter 索引需要用户干预，数据写入时默认不会生成这两种索引，用户可以有选择地为指定的列添加这两种索引，可以称其为需要手动创建的<strong>二级索引</strong></p>
<h2 id="segment储存格式与index的关系">segment储存格式与index的关系 </h2>
<p>doris的默认数存储单元为segment，Segment 文件可以有多个，一般按照大小进行分割，默认为 256MB。其中，Segment v2 文件命名规则为：${rowset_id}_${segment_id}.dat</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>[lcz@nn1 segment]$ tree storage/data/10/31765/610265476 -h
storage/data/10/31765/610265476
├── [4.5M]  02000000000000099b47cf624aae3cacfc8a4d3680f849bb_0_31761.idx
├── [ 19M]  02000000000000099b47cf624aae3cacfc8a4d3680f849bb_0.dat
├── [4.5M]  02000000000000388d4bccd0cd2579e87b3e774d17d3de96_0_31761.idx
└── [ 19M]  02000000000000388d4bccd0cd2579e87b3e774d17d3de96_0.dat
</code></pre><p>其中两个.dat后缀的文件就是segment文件，idx后缀的文件为<strong>倒排索引</strong>生成的，.idx文件可以看做与segment不相干，因此可以对存量数据新增倒排索引，且不需要对已有的segment进行操作。</p>
<p>doris官方给出的segment的数据结构如下图所示：<br>
<img src="./image/image.png" alt="Alt text"><br>
整理一下可以按照下面的格式查看：<br>
<img src="./image/image-1.png" alt="Alt text"></p>
<p>文件包括：</p>
<ul>
<li>文件开始是8个字节的magic code，用于识别文件格式和版本</li>
<li>Data Region：用于存储各个列的数据信息，这里的数据是按需分page加载的</li>
<li>Index Region: doris中将各个列的index数据统一存储在Index Region，这里的数据会按照列粒度进行加载，所以跟列的数据信息分开存储</li>
<li>Footer信息
<ul>
<li>FileFooterPB:定义文件的元数据信息</li>
<li>4个字节的footer pb内容的checksum</li>
<li>4个字节的FileFooterPB消息长度，用于读取FileFooterPB</li>
<li>8个字节的MAGIC CODE，之所以在末位存储，是方便不同的场景进行文件类型的识别</li>
</ul>
</li>
</ul>
<p><strong>FileFooterPB结构</strong><br>
<img src="./image/image-2.png" alt="Alt text"></p>
<p>为了防止索引本身数据量过大，ZoneMapIndex、BitMapIndex、BloomFilterIndex 采用了两级的 Page 管理。对应了 IndexColumnMeta 的结构，当一个 Page 能够放下时，当前 Page 直接存放索引数据，即采用 1 级结构；当一个 Page 无法放下时，索引数据写入新的 Page 中，Root Page 存储数据 Page 的地址信息。</p>
<h2 id="segment读写逻辑与index读写逻辑的关系简介">segment读写逻辑与index读写逻辑的关系简介 </h2>
<h3 id="index的写入流程">index的写入流程 </h3>
<p><img src="./image/image-3.png" alt="Alt text"></p>
<h3 id="模块关系">模块关系 </h3>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="655px" preserveAspectRatio="none" style="width:1204px;height:655px;background:#FFFFFF;" version="1.1" viewBox="0 0 1204 655" width="1204px" zoomAndPan="magnify"><defs></defs><g><!--class SegmentWriter--><g id="elem_SegmentWriter"><rect codeline="1" fill="#F1F1F1" height="210.9688" id="SegmentWriter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="497" x="295.75" y="7"></rect><ellipse cx="488.5" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M492.6406,28.3125 Q491.7656,28.7813 490.8047,29.0078 Q489.8438,29.2344 488.8125,29.2344 Q485.7188,29.2344 483.9063,27.5078 Q482.0938,25.7813 482.0938,22.8125 Q482.0938,19.8438 483.9063,18.1094 Q485.7188,16.375 488.8125,16.375 Q489.8438,16.375 490.8047,16.6094 Q491.7656,16.8438 492.6406,17.2969 L492.6406,19.875 Q491.75,19.2656 490.8906,18.9844 Q490.0313,18.7031 489.0625,18.7031 Q487.3594,18.7031 486.3828,19.7969 Q485.4063,20.8906 485.4063,22.8125 Q485.4063,24.7344 486.3828,25.8281 Q487.3594,26.9219 489.0625,26.9219 Q490.0313,26.9219 490.8906,26.6406 Q491.75,26.3594 492.6406,25.75 L492.6406,28.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="509" y="27.8467">SegmentWriter</text><line style="stroke:#181818;stroke-width:0.5;" x1="296.75" x2="791.75" y1="39" y2="39"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="458" x="301.75" y="55.9951">std::unique_ptr&lt;ShortKeyIndexBuilder&gt; _short_key_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="485" x="301.75" y="72.292">std::unique_ptr&lt;PrimaryKeyIndexBuilder&gt; _primary_key_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="442" x="301.75" y="88.5889">std::vector&lt;std::unique_ptr&lt;ColumnWriter&gt;&gt; _column_writers;</text><line style="stroke:#181818;stroke-width:0.5;" x1="296.75" x2="791.75" y1="95.8906" y2="95.8906"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="200" x="301.75" y="112.8857">Status _write_ordinal_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="182" x="301.75" y="129.1826">Status _write_zone_map();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="201" x="301.75" y="145.4795">Status _write_bitmap_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="210" x="301.75" y="161.7764">Status _write_inverted_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="233" x="301.75" y="178.0732">Status _write_bloom_filter_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="221" x="301.75" y="194.3701">Status _write_short_key_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="235" x="301.75" y="210.667">Status _write_primary_key_index();</text></g><!--class ColumnWriter--><g id="elem_ColumnWriter"><rect codeline="13" fill="#F1F1F1" height="48" id="ColumnWriter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="125" x="193.75" y="295.5"></rect><ellipse cx="208.75" cy="311.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M212.8906,316.8125 Q212.0156,317.2813 211.0547,317.5078 Q210.0938,317.7344 209.0625,317.7344 Q205.9688,317.7344 204.1563,316.0078 Q202.3438,314.2813 202.3438,311.3125 Q202.3438,308.3438 204.1563,306.6094 Q205.9688,304.875 209.0625,304.875 Q210.0938,304.875 211.0547,305.1094 Q212.0156,305.3438 212.8906,305.7969 L212.8906,308.375 Q212,307.7656 211.1406,307.4844 Q210.2813,307.2031 209.3125,307.2031 Q207.6094,307.2031 206.6328,308.2969 Q205.6563,309.3906 205.6563,311.3125 Q205.6563,313.2344 206.6328,314.3281 Q207.6094,315.4219 209.3125,315.4219 Q210.2813,315.4219 211.1406,315.1406 Q212,314.8594 212.8906,314.25 L212.8906,316.8125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="222.75" y="316.3467">ColumnWriter</text><line style="stroke:#181818;stroke-width:0.5;" x1="194.75" x2="317.75" y1="327.5" y2="327.5"></line><line style="stroke:#181818;stroke-width:0.5;" x1="194.75" x2="317.75" y1="335.5" y2="335.5"></line></g><!--class ScalarColumnWriter--><g id="elem_ScalarColumnWriter"><rect codeline="16" fill="#F1F1F1" height="227.2656" id="ScalarColumnWriter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="498" x="7" y="421"></rect><ellipse cx="184.75" cy="437" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M188.8906,442.3125 Q188.0156,442.7813 187.0547,443.0078 Q186.0938,443.2344 185.0625,443.2344 Q181.9688,443.2344 180.1563,441.5078 Q178.3438,439.7813 178.3438,436.8125 Q178.3438,433.8438 180.1563,432.1094 Q181.9688,430.375 185.0625,430.375 Q186.0938,430.375 187.0547,430.6094 Q188.0156,430.8438 188.8906,431.2969 L188.8906,433.875 Q188,433.2656 187.1406,432.9844 Q186.2813,432.7031 185.3125,432.7031 Q183.6094,432.7031 182.6328,433.7969 Q181.6563,434.8906 181.6563,436.8125 Q181.6563,438.7344 182.6328,439.8281 Q183.6094,440.9219 185.3125,440.9219 Q186.2813,440.9219 187.1406,440.6406 Q188,440.3594 188.8906,439.75 L188.8906,442.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="205.25" y="441.8467">ScalarColumnWriter</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="504" y1="453" y2="453"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="415" x="13" y="469.9951">std::unique_ptr&lt;OrdinalIndexWriter&gt; _ordinal_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="459" x="13" y="486.292">std::unique_ptr&lt;ZoneMapIndexWriter&gt; _zone_map_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="416" x="13" y="502.5889">std::unique_ptr&lt;BitmapIndexWriter&gt; _bitmap_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="13" y="518.8857">std::unique_ptr&lt;InvertedIndexColumnWriter&gt; _inverted_index_builder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="477" x="13" y="535.1826">std::unique_ptr&lt;BloomFilterIndexWriter&gt; _bloom_filter_index_builder;</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="504" y1="542.4844" y2="542.4844"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="237" x="13" y="559.4795">virtual Status write_ordinal_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="219" x="13" y="575.7764">virtual Status write_zone_map();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="238" x="13" y="592.0732">virtual Status write_bitmap_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="247" x="13" y="608.3701">virtual Status write_inverted_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="268" x="13" y="624.667">virtual size_t get_inverted_index_size();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="270" x="13" y="640.9639">virtual Status write_bloom_filter_index();</text></g><!--class ShortKeyIndexBuilder--><g id="elem_ShortKeyIndexBuilder"><rect codeline="30" fill="#F1F1F1" height="80.5938" id="ShortKeyIndexBuilder" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="380" x="354" y="279"></rect><ellipse cx="466.25" cy="295" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M470.3906,300.3125 Q469.5156,300.7813 468.5547,301.0078 Q467.5938,301.2344 466.5625,301.2344 Q463.4688,301.2344 461.6563,299.5078 Q459.8438,297.7813 459.8438,294.8125 Q459.8438,291.8438 461.6563,290.1094 Q463.4688,288.375 466.5625,288.375 Q467.5938,288.375 468.5547,288.6094 Q469.5156,288.8438 470.3906,289.2969 L470.3906,291.875 Q469.5,291.2656 468.6406,290.9844 Q467.7813,290.7031 466.8125,290.7031 Q465.1094,290.7031 464.1328,291.7969 Q463.1563,292.8906 463.1563,294.8125 Q463.1563,296.7344 464.1328,297.8281 Q465.1094,298.9219 466.8125,298.9219 Q467.7813,298.9219 468.6406,298.6406 Q469.5,298.3594 470.3906,297.75 L470.3906,300.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="486.75" y="299.8467">ShortKeyIndexBuilder</text><line style="stroke:#181818;stroke-width:0.5;" x1="355" x2="733" y1="311" y2="311"></line><line style="stroke:#181818;stroke-width:0.5;" x1="355" x2="733" y1="319" y2="319"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="360" y="335.9951">Status add_item(const Slice&amp; key);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="368" x="360" y="352.292">Status finalize(...segment_v2::PageFooterPB* footer);</text></g><!--class PrimaryKeyIndexBuilder--><g id="elem_PrimaryKeyIndexBuilder"><rect codeline="34" fill="#F1F1F1" height="80.5938" id="PrimaryKeyIndexBuilder" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="428" x="769" y="279"></rect><ellipse cx="898.75" cy="295" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M902.8906,300.3125 Q902.0156,300.7813 901.0547,301.0078 Q900.0938,301.2344 899.0625,301.2344 Q895.9688,301.2344 894.1563,299.5078 Q892.3438,297.7813 892.3438,294.8125 Q892.3438,291.8438 894.1563,290.1094 Q895.9688,288.375 899.0625,288.375 Q900.0938,288.375 901.0547,288.6094 Q902.0156,288.8438 902.8906,289.2969 L902.8906,291.875 Q902,291.2656 901.1406,290.9844 Q900.2813,290.7031 899.3125,290.7031 Q897.6094,290.7031 896.6328,291.7969 Q895.6563,292.8906 895.6563,294.8125 Q895.6563,296.7344 896.6328,297.8281 Q897.6094,298.9219 899.3125,298.9219 Q900.2813,298.9219 901.1406,298.6406 Q902,298.3594 902.8906,297.75 L902.8906,300.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="160" x="919.25" y="299.8467">PrimaryKeyIndexBuilder</text><line style="stroke:#181818;stroke-width:0.5;" x1="770" x2="1196" y1="311" y2="311"></line><line style="stroke:#181818;stroke-width:0.5;" x1="770" x2="1196" y1="319" y2="319"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="775" y="335.9951">Status add_item(const Slice&amp; key);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="416" x="775" y="352.292">Status finalize(segment_v2::PrimaryKeyIndexMetaPB* meta);</text></g><!--reverse link ColumnWriter to ScalarColumnWriter--><g id="link_ColumnWriter_ScalarColumnWriter"><path codeline="38" d="M256,361.7 C256,380.785 256,391.357 256,420.577 " fill="none" id="ColumnWriter-backto-ScalarColumnWriter" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="none" points="256,343.7,250,361.7,262,361.7,256,343.7" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link SegmentWriter to ColumnWriter--><g id="link_SegmentWriter_ColumnWriter"><path codeline="39" d="M387.2708,225.0609 C346.3618,254.1809 315.546,276.115 288.487,295.376 " fill="none" id="SegmentWriter-backto-ColumnWriter" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="397.047,218.102,389.8393,218.3227,387.2708,225.0609,394.4786,224.8402,397.047,218.102" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link SegmentWriter to ShortKeyIndexBuilder--><g id="link_SegmentWriter_ShortKeyIndexBuilder"><path codeline="40" d="M544,230.102 C544,251.818 544,261.409 544,278.972 " fill="none" id="SegmentWriter-backto-ShortKeyIndexBuilder" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="544,218.102,540,224.102,544,230.102,548,224.102,544,218.102" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link SegmentWriter to PrimaryKeyIndexBuilder--><g id="link_SegmentWriter_PrimaryKeyIndexBuilder"><path codeline="41" d="M778.874,223.1792 C825.379,244.8952 860.741,261.409 898.352,278.972 " fill="none" id="SegmentWriter-backto-PrimaryKeyIndexBuilder" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="768.001,218.102,771.7451,224.2649,778.874,223.1792,775.1299,217.0163,768.001,218.102" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--SRC=[fLInRi8m4Dtp5PugG8AXOq0CL4925IfIXafTB9CSrAeJKzj92ot_Njk1WXtNhTGiINpldf_VtJbdH4gKmRQ4IZqAga2WZmJf9rD4rHBXDxE8kIXeHHYcLG7llVuu03dm2d19Tk7ecYeTY-NJgW6Xe8XXrepp4cyeqpfZEFdCXS8li8-1TeAMHEoxCAcADAqh-bfha1AJpB3TmtvXGBEQiWB45FcRu7KR2NEisiswB1qL0Pu6SiN5nEUyuwmkgxPgKqsLs__sT4AEasEIs_9UutHrlzUpd30YlAZPjA52rOIT_OgqG13fTq8G56g8833S5sUef0V02cr1UK1i8d45FpQJR_H3UtHRkPFToFKZNlmdRSYIxDpyiqj_8PXPizpyQmFZsOkJCJRVQHhacnPNOGoRMxyyAHqdBqJ7vDnjWIboxnfIQ1aAobxEAwbGncWEDqWFXZk-6sExAUveD9BjpOMRspHTaItCETSQLhC1sjYl_cKAmXFuFmNEzYx_4XGnEahzjYgSEPjy3eU1-KlSctYWGR-4Gwu6OE73Vm40]--></g></svg></p><p>SegmentWriter中包含_column_writers与_short_key_index_builder对象，short key index的写入逻辑实际在SegmentWriter中调用，其他的index写入逻辑是透过ColumnWriter调用的</p>
<h3 id="index的读取流程">index的读取流程 </h3>
<center>
<p><img src="./image/image-4.png" alt="Alt text"></p>
</center>
<h3 id="模块关系-1">模块关系 </h3>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="1072px" preserveAspectRatio="none" style="width:852px;height:1072px;background:#FFFFFF;" version="1.1" viewBox="0 0 852 1072" width="852px" zoomAndPan="magnify"><defs></defs><g><!--class Segment--><g id="elem_Segment"><rect codeline="1" fill="#F1F1F1" height="210.9688" id="Segment" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="513" x="7" y="343.5"></rect><ellipse cx="227.75" cy="359.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M231.8906,364.8125 Q231.0156,365.2813 230.0547,365.5078 Q229.0938,365.7344 228.0625,365.7344 Q224.9688,365.7344 223.1563,364.0078 Q221.3438,362.2813 221.3438,359.3125 Q221.3438,356.3438 223.1563,354.6094 Q224.9688,352.875 228.0625,352.875 Q229.0938,352.875 230.0547,353.1094 Q231.0156,353.3438 231.8906,353.7969 L231.8906,356.375 Q231,355.7656 230.1406,355.4844 Q229.2813,355.2031 228.3125,355.2031 Q226.6094,355.2031 225.6328,356.2969 Q224.6563,357.3906 224.6563,359.3125 Q224.6563,361.2344 225.6328,362.3281 Q226.6094,363.4219 228.3125,363.4219 Q229.2813,363.4219 230.1406,363.1406 Q231,362.8594 231.8906,362.25 L231.8906,364.8125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63" x="248.25" y="364.3467">Segment</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="519" y1="375.5" y2="375.5"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="414" x="13" y="392.4951">std::unique_ptr&lt;PrimaryKeyIndexMetaPB&gt; _pk_index_meta;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="501" x="13" y="408.792">std::map&lt;int32_t, std::unique_ptr&lt;ColumnReader&gt;&gt; _column_readers;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="430" x="13" y="425.0889">std::unique_ptr&lt;ShortKeyIndexDecoder&gt; _sk_index_decoder;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="421" x="13" y="441.3857">std::unique_ptr&lt;PrimaryKeyIndexReader&gt; _pk_index_reader;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="199" x="13" y="457.6826">friend class SegmentIterator;</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="519" y1="464.9844" y2="464.9844"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="218" x="13" y="481.9795">Status new_column_iterator(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="258" x="13" y="498.2764">Status new_bitmap_index_iterator(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="267" x="13" y="514.5732">Status new_inverted_index_iterator(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="412" x="13" y="530.8701">const ShortKeyIndexDecoder* get_short_key_index() const;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="429" x="13" y="547.167">const PrimaryKeyIndexReader* get_primary_key_index() const;</text></g><!--class SegmentIterator--><g id="elem_SegmentIterator"><rect codeline="13" fill="#F1F1F1" height="276.1563" id="SegmentIterator" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="605" x="140" y="7"></rect><ellipse cx="382.25" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M386.3906,28.3125 Q385.5156,28.7813 384.5547,29.0078 Q383.5938,29.2344 382.5625,29.2344 Q379.4688,29.2344 377.6563,27.5078 Q375.8438,25.7813 375.8438,22.8125 Q375.8438,19.8438 377.6563,18.1094 Q379.4688,16.375 382.5625,16.375 Q383.5938,16.375 384.5547,16.6094 Q385.5156,16.8438 386.3906,17.2969 L386.3906,19.875 Q385.5,19.2656 384.6406,18.9844 Q383.7813,18.7031 382.8125,18.7031 Q381.1094,18.7031 380.1328,19.7969 Q379.1563,20.8906 379.1563,22.8125 Q379.1563,24.7344 380.1328,25.8281 Q381.1094,26.9219 382.8125,26.9219 Q383.7813,26.9219 384.6406,26.6406 Q385.5,26.3594 386.3906,25.75 L386.3906,28.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="402.75" y="27.8467">SegmentIterator</text><line style="stroke:#181818;stroke-width:0.5;" x1="141" x2="744" y1="39" y2="39"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="146" y="55.9951">std::vector&lt;std::unique_ptr&lt;ColumnIterator&gt;&gt; _column_iterators;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="534" x="146" y="72.292">std::vector&lt;std::unique_ptr&lt;BitmapIndexIterator&gt;&gt; _bitmap_index_iterators;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="551" x="146" y="88.5889">std::vector&lt;std::unique_ptr&lt;InvertedIndexIterator&gt;&gt; _inverted_index_iterators;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="206" x="146" y="104.8857">roaring::Roaring _row_bitmap;</text><line style="stroke:#181818;stroke-width:0.5;" x1="141" x2="744" y1="112.1875" y2="112.1875"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="242" x="146" y="129.1826">Status _get_row_ranges_by_keys();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="340" x="146" y="145.4795">Status _get_row_ranges_by_column_conditions();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="204" x="146" y="161.7764">Status _apply_bitmap_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="213" x="146" y="178.0732">Status _apply_inverted_index();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="549" x="146" y="194.3701">Status _apply_inverted_index_on_column_predicate(ColumnPredicate* pred, ...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="593" x="146" y="210.667">Status _apply_inverted_index_on_block_column_predicate(ColumnPredicate* pred, ...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="542" x="146" y="226.9639">Status _get_row_ranges_from_conditions(RowRanges* condition_row_ranges);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="182" x="146" y="243.2607">Status _lookup_ordinal(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="287" x="146" y="259.5576">Status _lookup_ordinal_from_sk_index(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="288" x="146" y="275.8545">Status _lookup_ordinal_from_pk_index(...);</text></g><!--class ColumnIterator--><g id="elem_ColumnIterator"><rect codeline="29" fill="#F1F1F1" height="48" id="ColumnIterator" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="555.25" y="425"></rect><ellipse cx="570.25" cy="441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M574.3906,446.3125 Q573.5156,446.7813 572.5547,447.0078 Q571.5938,447.2344 570.5625,447.2344 Q567.4688,447.2344 565.6563,445.5078 Q563.8438,443.7813 563.8438,440.8125 Q563.8438,437.8438 565.6563,436.1094 Q567.4688,434.375 570.5625,434.375 Q571.5938,434.375 572.5547,434.6094 Q573.5156,434.8438 574.3906,435.2969 L574.3906,437.875 Q573.5,437.2656 572.6406,436.9844 Q571.7813,436.7031 570.8125,436.7031 Q569.1094,436.7031 568.1328,437.7969 Q567.1563,438.8906 567.1563,440.8125 Q567.1563,442.7344 568.1328,443.8281 Q569.1094,444.9219 570.8125,444.9219 Q571.7813,444.9219 572.6406,444.6406 Q573.5,444.3594 574.3906,443.75 L574.3906,446.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="584.25" y="445.8467">ColumnIterator</text><line style="stroke:#181818;stroke-width:0.5;" x1="556.25" x2="688.25" y1="457" y2="457"></line><line style="stroke:#181818;stroke-width:0.5;" x1="556.25" x2="688.25" y1="465" y2="465"></line></g><!--class FileColumnIterator--><g id="elem_FileColumnIterator"><rect codeline="31" fill="#F1F1F1" height="113.1875" id="FileColumnIterator" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="350" x="447.25" y="615.5"></rect><ellipse cx="555.5" cy="631.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M559.6406,636.8125 Q558.7656,637.2813 557.8047,637.5078 Q556.8438,637.7344 555.8125,637.7344 Q552.7188,637.7344 550.9063,636.0078 Q549.0938,634.2813 549.0938,631.3125 Q549.0938,628.3438 550.9063,626.6094 Q552.7188,624.875 555.8125,624.875 Q556.8438,624.875 557.8047,625.1094 Q558.7656,625.3438 559.6406,625.7969 L559.6406,628.375 Q558.75,627.7656 557.8906,627.4844 Q557.0313,627.2031 556.0625,627.2031 Q554.3594,627.2031 553.3828,628.2969 Q552.4063,629.3906 552.4063,631.3125 Q552.4063,633.2344 553.3828,634.3281 Q554.3594,635.4219 556.0625,635.4219 Q557.0313,635.4219 557.8906,635.1406 Q558.75,634.8594 559.6406,634.25 L559.6406,636.8125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="576" y="636.3467">FileColumnIterator</text><line style="stroke:#181818;stroke-width:0.5;" x1="448.25" x2="796.25" y1="647.5" y2="647.5"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="249" x="453.25" y="664.4951">OrdinalPageIndexIterator _page_iter;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="171" x="453.25" y="680.792">ColumnReader* _reader;</text><line style="stroke:#181818;stroke-width:0.5;" x1="448.25" x2="796.25" y1="688.0938" y2="688.0938"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="331" x="453.25" y="705.0889">virtual Status get_row_ranges_by_zone_map(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="338" x="453.25" y="721.3857">virtual Status get_row_ranges_by_bloom_filter(...);</text></g><!--class ColumnReader--><g id="elem_ColumnReader"><rect codeline="37" fill="#F1F1F1" height="276.1563" id="ColumnReader" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="445" x="400" y="789"></rect><ellipse cx="566.75" cy="805" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"></ellipse><path d="M570.8906,810.3125 Q570.0156,810.7813 569.0547,811.0078 Q568.0938,811.2344 567.0625,811.2344 Q563.9688,811.2344 562.1563,809.5078 Q560.3438,807.7813 560.3438,804.8125 Q560.3438,801.8438 562.1563,800.1094 Q563.9688,798.375 567.0625,798.375 Q568.0938,798.375 569.0547,798.6094 Q570.0156,798.8438 570.8906,799.2969 L570.8906,801.875 Q570,801.2656 569.1406,800.9844 Q568.2813,800.7031 567.3125,800.7031 Q565.6094,800.7031 564.6328,801.7969 Q563.6563,802.8906 563.6563,804.8125 Q563.6563,806.7344 564.6328,807.8281 Q565.6094,808.9219 567.3125,808.9219 Q568.2813,808.9219 569.1406,808.6406 Q570,808.3594 570.8906,807.75 L570.8906,810.3125 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="587.25" y="809.8467">ColumnReader</text><line style="stroke:#181818;stroke-width:0.5;" x1="401" x2="844" y1="821" y2="821"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="415" x="406" y="837.9951">std::unique_ptr&lt;ZoneMapIndexReader&gt; _zone_map_index;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="371" x="406" y="854.292">std::unique_ptr&lt;OrdinalIndexReader&gt; _ordinal_index;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="372" x="406" y="870.5889">std::unique_ptr&lt;BitmapIndexReader&gt; _bitmap_index;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="389" x="406" y="886.8857">std::shared_ptr&lt;InvertedIndexReader&gt; _inverted_index;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="433" x="406" y="903.1826">std::shared_ptr&lt;BloomFilterIndexReader&gt; _bloom_filter_index;</text><line style="stroke:#181818;stroke-width:0.5;" x1="401" x2="844" y1="910.4844" y2="910.4844"></line><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="258" x="406" y="927.4795">Status new_bitmap_index_iterator(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="267" x="406" y="943.7764">Status new_inverted_index_iterator(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="287" x="406" y="960.0732">Status get_row_ranges_by_zone_map(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="294" x="406" y="976.3701">Status get_row_ranges_by_bloom_filter(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="234" x="406" y="992.667">Status _load_zone_map_index(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="208" x="406" y="1008.9639">Status _load_ordinal_index(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="209" x="406" y="1025.2607">Status _load_bitmap_index(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="262" x="406" y="1041.5576">Status _load_inverted_index_index(...);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="406" y="1057.8545">Status _load_bloom_filter_index(...);</text></g><!--reverse link SegmentIterator to Segment--><g id="link_SegmentIterator_Segment"><path codeline="53" d="M354.7497,293.6261 C342.8367,313.7261 336.848,323.83 325.401,343.142 " fill="none" id="SegmentIterator-backto-Segment" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="360.868,283.303,354.3678,286.4251,354.7497,293.6261,361.2499,290.504,360.868,283.303" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link ColumnIterator to FileColumnIterator--><g id="link_ColumnIterator_FileColumnIterator"><path codeline="54" d="M622.25,491.233 C622.25,524.701 622.25,569.494 622.25,615.373 " fill="none" id="ColumnIterator-backto-FileColumnIterator" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="none" points="622.25,473.233,616.25,491.233,628.25,491.233,622.25,473.233" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link FileColumnIterator to ColumnReader--><g id="link_FileColumnIterator_ColumnReader"><path codeline="55" d="M622.25,740.522 C622.25,758.631 622.25,767.611 622.25,788.993 " fill="none" id="FileColumnIterator-backto-ColumnReader" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="622.25,728.522,618.25,734.522,622.25,740.522,626.25,734.522,622.25,728.522" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--reverse link SegmentIterator to ColumnIterator--><g id="link_SegmentIterator_ColumnIterator"><path codeline="56" d="M530.2298,293.6109 C562.5488,347.8349 590.14,394.126 608.435,424.822 " fill="none" id="SegmentIterator-backto-ColumnIterator" style="stroke:#181818;stroke-width:1.0;"></path><polygon fill="#181818" points="524.086,283.303,523.7219,290.5049,530.2298,293.6109,530.5939,286.409,524.086,283.303" style="stroke:#181818;stroke-width:1.0;"></polygon></g><!--SRC=[hLLDRnen4BtpAtmaAE6GtW3bGAj8A8gAuDQBPNO7Oh5hRsqlb7xyzthNzcAl3I5gSmgUUMyyp_Dciu98YTQmAu4fz6k0z9zK-MHIC_gz1bmfCLiAMX9nUe7JWkNmunKKMSwV4Axsc3O7kDGdqpEq9DMCClNf4QlxYEmpB-gIhO3a89uqITR-ng8zaDFa1TPlN2XN_WjalC4YB5tzt1nDRxczhUpTtfGsuAsWm7AK-Qei50YYkCrOAw9gYHWStTMfZG_7u_5TbBIXIkjXIrrFfUm0Ga5-EJdZJ2gKacE4Tg2mR29u3oT3CRmp21-SbCEWAnDAuVyCafBOWR4zu8P4y2CMXEr0uarB9OTXfuaiAwIkbLD5TSK-X5HLSGgaJ6U42jwIWpbpvIi1ESs8Wg6PqQNxFK9Dw1v5ZtQHSLFmRFyFl3s9jeANlZehVboraH7gJhty7bd1-RwkC1SvPQI8Hw-NOAevRzsONiNfhGyFaEancQMNW9iYRmsucPVlSypRQMY7s2TA-kq6keLzn8ZmWYijfU14KBQRJ5Rc7zI-Wxd4sJPXlzerBl1C2uY23U-12bMJmeaUU-OdPu1r4K_nTp5wBFLRRMcXQtcuh-ObbsG7GVTwH-gZjcEJwE_k4UeMPzYb2OURuRylme_8yb4vpdDEyexlYXjqblF2rQHWVLt8wNT-bS-xVjfztdX_qtsyMhjqdy2mkJJG3aS83FfDupnxTZ1V0GybtuZUWx4BEroeIXevRzHuRiNe5OraQYQs_o4RFJouZzkWPyZPRnsBZJf8UBTXyLsGB1DY_W80]--></g></svg></p><h2 id="索引介绍">索引介绍 </h2>
<p>下面对各种具体类型的索引分别进行介绍</p>
<h3 id="ordinal-索引">Ordinal 索引 </h3>
<h4 id="索引概述">索引概述 </h4>
<p>Apache Doris 底层采用列存的方式来存储数据，每一列数据会被分为多个Data Page。</p>
<p>数据刷写时，会为每一个Data Page生成一条Ordinal索引项，其中保存Data Page在Segment文件中的offset、Data Page的大小以及Data Page的起始行号，所有Data Page的Ordinal索引项会保存在一个Ordinal Index Page中， Ordinal Index Page在Segment文件中的offset以及Ordinal Index Page的大小会被保存在Segment文件的footer中，以便于数据读取时能够通过两级索引找到Data Page（首先，通过Segment文件的footer找到Ordinal Index Page，然后，通过Ordinal Index Page中的索引项找到Data Page）。</p>
<p><img src="./image/image-5.png" alt="Alt text"><br>
Ordinal Index Page的结构可以参考OrdinalIndexPB。</p>
<h4 id="索引生成">索引生成 </h4>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="191px" preserveAspectRatio="none" style="width:452px;height:191px;background:#FFFFFF;" version="1.1" viewBox="0 0 452 191" width="452px" zoomAndPan="magnify"><defs></defs><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="79" x2="79" y1="36.2969" y2="156.6953"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="232" x2="232" y1="36.2969" y2="156.6953"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="379" x2="379" y1="36.2969" y2="156.6953"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="12" y="24.9951">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="5" y="155.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="12" y="175.6904">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="163" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="170" y="24.9951">OrdinalIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="163" y="155.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="170" y="175.6904">OrdinalIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="312" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="319" y="24.9951">IndexPageBuilder</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="312" y="155.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="319" y="175.6904">IndexPageBuilder</text><line style="stroke:#181818;stroke-width:1.0;" x1="79" x2="121" y1="67.4297" y2="67.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="121" x2="121" y1="67.4297" y2="80.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="80" x2="121" y1="80.4297" y2="80.4297"></line><polygon fill="#181818" points="90,76.4297,80,80.4297,90,84.4297,86,80.4297" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="86" y="62.3638">_write_data_page()</text><polygon fill="#181818" points="220.5,105.5625,230.5,109.5625,220.5,113.5625,224.5,109.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="79" x2="226.5" y1="109.5625" y2="109.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="86" y="104.4966">append_entry()</text><polygon fill="#181818" points="367,134.6953,377,138.6953,367,142.6953,371,138.6953" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;" x1="232.5" x2="373" y1="138.6953" y2="138.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="239.5" y="133.6294">add()</text><!--SRC=[2qvEp4aiSixFAStD2o_AB4ajKj2rKmZ64BLIY2y7CU9J4aiIumiIqrCrDBc2iMW6wlOlIidCIypnp4j9hO3fJYmeICrBYK_DAocg1Eh4L0Ao5imD09hjL9gPamBMbfAYeGa0]--></g></svg></p><p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="429px" preserveAspectRatio="none" style="width:810px;height:429px;background:#FFFFFF;" version="1.1" viewBox="0 0 810 429" width="810px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="236.0625" style="stroke:#000000;stroke-width:1.5;" width="510.5" x="292.5" y="140.6953"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="63" x2="63" y1="36.2969" y2="393.7578"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="218.5" x2="218.5" y1="36.2969" y2="393.7578"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="371.5" x2="371.5" y1="36.2969" y2="393.7578"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="559" x2="559" y1="36.2969" y2="393.7578"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="714" x2="714" y1="36.2969" y2="393.7578"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="24.9951">SegmentWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="392.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="412.7529">SegmentWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="144.5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="151.5" y="24.9951">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="144.5" y="392.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="151.5" y="412.7529">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="302.5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="309.5" y="24.9951">OrdinalIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="302.5" y="392.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="309.5" y="412.7529">OrdinalIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="492" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="499" y="24.9951">IndexPageBuilder</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="492" y="392.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="499" y="412.7529">IndexPageBuilder</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="157" x="636" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="643" y="24.9951">ColumnIndexMetaPB</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="157" x="636" y="392.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="643" y="412.7529">ColumnIndexMetaPB</text><polygon fill="#181818" points="206.5,63.4297,216.5,67.4297,206.5,71.4297,210.5,67.4297" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;" x1="63.5" x2="212.5" y1="67.4297" y2="67.4297"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="70.5" y="62.3638">write_ordinal_index()</text><polygon fill="#181818" points="360,92.5625,370,96.5625,360,100.5625,364,96.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="218.5" x2="366" y1="96.5625" y2="96.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="225.5" y="91.4966">finish()</text><polygon fill="#181818" points="547,121.6953,557,125.6953,547,129.6953,551,125.6953" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="553" y1="125.6953" y2="125.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="379" y="120.6294">count()</text><path d="M292.5,140.6953 L356.5,140.6953 L356.5,147.8281 L346.5,157.8281 L292.5,157.8281 L292.5,140.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="236.0625" style="stroke:#000000;stroke-width:1.5;" width="510.5" x="292.5" y="140.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="307.5" y="153.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="73" x="371.5" y="152.9058">[count is 1]</text><polygon fill="#181818" points="702.5,174.9609,712.5,178.9609,702.5,182.9609,706.5,178.9609" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="708.5" y1="178.9609" y2="178.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="379" y="173.895">set_is_root_data_page(true)</text><polygon fill="#181818" points="702.5,204.0938,712.5,208.0938,702.5,212.0938,706.5,208.0938" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="708.5" y1="208.0938" y2="208.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="379" y="203.0278">to_proto()</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="292.5" x2="803" y1="217.0938" y2="217.0938"></line><polygon fill="#181818" points="547,235.2266,557,239.2266,547,243.2266,551,239.2266" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="553" y1="239.2266" y2="239.2266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="379" y="234.1606">finish()</text><polygon fill="#181818" points="383,264.3594,373,268.3594,383,272.3594,379,268.3594" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="377" x2="558" y1="268.3594" y2="268.3594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="389" y="263.2935">page_footer &amp; page body</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="414" y1="297.4922" y2="297.4922"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="414" x2="414" y1="297.4922" y2="310.4922"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="373" x2="414" y1="310.4922" y2="310.4922"></line><polygon fill="#181818" points="383,306.4922,373,310.4922,383,314.4922,379,310.4922" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="379" y="292.4263">PageIO::write_page</text><polygon fill="#181818" points="702.5,335.625,712.5,339.625,702.5,343.625,706.5,339.625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="708.5" y1="339.625" y2="339.625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="379" y="334.5591">set_is_root_data_page(true)</text><polygon fill="#181818" points="702.5,364.7578,712.5,368.7578,702.5,372.7578,706.5,368.7578" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="372" x2="708.5" y1="368.7578" y2="368.7578"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="379" y="363.6919">to_proto()</text><!--SRC=[pL6x3W8X4EpzYgsC5bVO4cDnLXP64mjBWiUg9CXUO2_gtxiSCJ6-4ZjfO8UPsM7PuE64WRVHCKQePh1fZ3TnJhuxXO8gEETTKxGk6AzTi7WPZGUlJAZ4O5LeYyow6-nTSEaecjVBNjFNQtF0kdFU2gYWeIwmA8pdSWQNO380MHzCIf8UNIARTIqk2Lcxf2CHQslOw5QQZ3XsEFxLYactaPWa4_g4t-JFptaOm0VLjAhUg79OlPVimXZs5Up8Nh-rVWChoAQBbLBb7xFFdymns1i0]--></g></svg></p><h4 id="索引读取">索引读取 </h4>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="354px" preserveAspectRatio="none" style="width:578px;height:354px;background:#FFFFFF;" version="1.1" viewBox="0 0 578 354" width="578px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="135.6641" style="stroke:#000000;stroke-width:1.5;" width="443" x="128" y="166.6953"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="63" x2="63" y1="36.2969" y2="319.3594"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="212" x2="212" y1="36.2969" y2="319.3594"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="356" x2="356" y1="36.2969" y2="319.3594"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="493" x2="493" y1="36.2969" y2="319.3594"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="24.9951">ColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="318.3594"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="338.3545">ColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="149" x="138" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="145" y="24.9951">OrdinalIndexReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="149" x="138" y="318.3594"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="145" y="338.3545">OrdinalIndexReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118" x="297" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="304" y="24.9951">OrdinalIndexPB</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118" x="297" y="318.3594"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="304" y="338.3545">OrdinalIndexPB</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136" x="425" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="432" y="24.9951">IndexPageReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136" x="425" y="318.3594"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="432" y="338.3545">IndexPageReader</text><line style="stroke:#181818;stroke-width:1.0;" x1="63.5" x2="105.5" y1="67.4297" y2="67.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="105.5" y1="67.4297" y2="80.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="64.5" x2="105.5" y1="80.4297" y2="80.4297"></line><polygon fill="#181818" points="74.5,76.4297,64.5,80.4297,74.5,84.4297,70.5,80.4297" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="70.5" y="62.3638">_load_ordinal_index()</text><polygon fill="#181818" points="200.5,105.5625,210.5,109.5625,200.5,113.5625,204.5,109.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="63.5" x2="206.5" y1="109.5625" y2="109.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="37" x="70.5" y="104.4966">load()</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="212.5" x2="254.5" y1="138.6953" y2="138.6953"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="254.5" x2="254.5" y1="138.6953" y2="151.6953"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="254.5" y1="151.6953" y2="151.6953"></line><polygon fill="#181818" points="223.5,147.6953,213.5,151.6953,223.5,155.6953,219.5,151.6953" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="219.5" y="133.6294">_load()</text><path d="M128,166.6953 L192,166.6953 L192,173.8281 L182,183.8281 L128,183.8281 L128,166.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="135.6641" style="stroke:#000000;stroke-width:1.5;" width="443" x="128" y="166.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="143" y="179.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="126" x="207" y="178.9058">[is_root_data_page]</text><polygon fill="#181818" points="344,200.9609,354,204.9609,344,208.9609,348,204.9609" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="212.5" x2="350" y1="204.9609" y2="204.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="219.5" y="199.895">read data page</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="128" x2="571" y1="213.9609" y2="213.9609"></line><polygon fill="#181818" points="344,232.0938,354,236.0938,344,240.0938,348,236.0938" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="212.5" x2="350" y1="236.0938" y2="236.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="219.5" y="231.0278">read index page</text><polygon fill="#181818" points="481,261.2266,491,265.2266,481,269.2266,485,265.2266" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="212.5" x2="487" y1="265.2266" y2="265.2266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="219.5" y="260.1606">parse to IndexPageReader</text><polygon fill="#181818" points="481,290.3594,491,294.3594,481,298.3594,485,294.3594" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="212.5" x2="487" y1="294.3594" y2="294.3594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="219.5" y="289.2935">read data page</text><!--SRC=[bSyx3i8m30RWlQVm20CNwC109YOG5x0isQeYXRXAWiJnSVgGQ162Pej-Vtuu3Ozxl0cn93WSmRtzMy2WnAY9VQI0Fh8yT_l6BOoXorXmhlbCgxJQp-YBW6cQ6Ge5VCQaMf2f4FRKIGFs_kXsFRMGB88gOP0IydO-70k_9e_6YkQpUqfPeEWwsTHalN_a5m00]--></g></svg></p><h4 id="索引使用">索引使用 </h4>
<p>一般是通过使用行号来获取该行所在的page，并返回page point。从代码上看，Ordinal索引不仅仅用于datapage，其他的index页如果需要的话也会使用Ordinal索引进行记录（IndexedColumnWriter）。</p>
<h3 id="zone-map-索引">Zone Map 索引 </h3>
<h4 id="索引概述-1">索引概述 </h4>
<p>Apache Doris 会为Segment文件中的一列数据添加Zone Map索引，同时会为列中的每一个Data Page添加Zone Map索引。Zone Map索引项中记录了每一列或列中每一个Data Page的最大值(max value)、最小值(min value)、是否有null值(has null)以及是否有非null值(has not null)的信息。初始化时，max value会被设置为当前列类型的最小值，min value会被设置为当前列类型的最大值，has null和has not null会被设置为false</p>
<p><img src="./image/image-12.png" alt="Alt text"></p>
<h4 id="索引生成-1">索引生成 </h4>
<p>数据写入阶段</p>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="383px" preserveAspectRatio="none" style="width:607px;height:383px;background:#FFFFFF;" version="1.1" viewBox="0 0 607 383" width="607px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="104.5313" style="stroke:#000000;stroke-width:1.5;" width="591" x="10" y="95.4297"></rect><rect fill="none" height="75.3984" style="stroke:#000000;stroke-width:1.5;" width="502" x="10" y="256.0938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="94" x2="94" y1="36.2969" y2="348.4922"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="312" x2="312" y1="36.2969" y2="348.4922"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="462" x2="462" y1="36.2969" y2="348.4922"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="568" x2="568" y1="36.2969" y2="348.4922"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="20" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="27" y="24.9951">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="20" y="347.4922"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="27" y="367.4873">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="200" x="212" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="219" y="24.9951">TypedZoneMapIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="200" x="212" y="347.4922"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="219" y="367.4873">TypedZoneMapIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="422" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="429" y="24.9951">ZoneMap</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="422" y="347.4922"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="429" y="367.4873">ZoneMap</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="545" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="552" y="24.9951">Field</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="545" y="347.4922"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="552" y="367.4873">Field</text><line style="stroke:#181818;stroke-width:1.0;" x1="94" x2="136" y1="67.4297" y2="67.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="136" x2="136" y1="67.4297" y2="80.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="95" x2="136" y1="80.4297" y2="80.4297"></line><polygon fill="#181818" points="105,76.4297,95,80.4297,105,84.4297,101,80.4297" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="101" y="62.3638">append_data_in_current_page()</text><path d="M10,95.4297 L74,95.4297 L74,102.5625 L64,112.5625 L10,112.5625 L10,95.4297 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="104.5313" style="stroke:#000000;stroke-width:1.5;" width="591" x="10" y="95.4297"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="108.4966">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="121" x="89" y="107.6401">[if need zone map]</text><polygon fill="#181818" points="300,129.6953,310,133.6953,300,137.6953,304,133.6953" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="94" x2="306" y1="133.6953" y2="133.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="101" y="128.6294">add_values() 批量数据加载</text><polygon fill="#181818" points="450,158.8281,460,162.8281,450,166.8281,454,162.8281" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="312" x2="456" y1="162.8281" y2="162.8281"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="319" y="157.7622">page is not null</text><polygon fill="#181818" points="556,187.9609,566,191.9609,556,195.9609,560,191.9609" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="312" x2="562" y1="191.9609" y2="191.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="319" y="186.895">compare and update min max value</text><line style="stroke:#181818;stroke-width:1.0;" x1="94" x2="136" y1="228.0938" y2="228.0938"></line><line style="stroke:#181818;stroke-width:1.0;" x1="136" x2="136" y1="228.0938" y2="241.0938"></line><line style="stroke:#181818;stroke-width:1.0;" x1="95" x2="136" y1="241.0938" y2="241.0938"></line><polygon fill="#181818" points="105,237.0938,95,241.0938,105,245.0938,101,241.0938" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="101" y="223.0278">append_nulls()</text><path d="M10,256.0938 L74,256.0938 L74,263.2266 L64,273.2266 L10,273.2266 L10,256.0938 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="75.3984" style="stroke:#000000;stroke-width:1.5;" width="502" x="10" y="256.0938"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="269.1606">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="121" x="89" y="268.3042">[if need zone map]</text><polygon fill="#181818" points="300,290.3594,310,294.3594,300,298.3594,304,294.3594" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="94" x2="306" y1="294.3594" y2="294.3594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="101" y="289.2935">add_nulls()</text><polygon fill="#181818" points="450,319.4922,460,323.4922,450,327.4922,454,323.4922" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="312" x2="456" y1="323.4922" y2="323.4922"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="319" y="318.4263">page is null</text><!--SRC=[hP0_IWKn4CRxdE8htokym2ji1C72QWN19WmxemIoio6RoDCBY89OsNi2iRLunt7HMpYxg8sAAAOSyltxDIr5oZjzh9qUvb0aOsiRpQVh2fIIA7kcGZweRslEeiKdEf75qb4i2CTG4SPvhuAEaeEzvei0IpWuIy97zd6Vqfwoh3zYcFqfnIh3Oednyl7bucQyVHYlxv-kxfutczdp6_5i_7R62bCpX07Q5sYDyKVfRf389cpxBb4Ma39gii6s9gWjMcDkveo3SyrloKqTXlz6zMxw1omJ4klr2W00]--></g></svg></p><p>数据flush 和 finish阶段，其中数据flush触发条件为page写满了或者主动finish</p>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="588px" preserveAspectRatio="none" style="width:795px;height:588px;background:#FFFFFF;" version="1.1" viewBox="0 0 795 588" width="795px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="193.9297" style="stroke:#000000;stroke-width:1.5;" width="601" x="10" y="138.5625"></rect><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1.5;" width="379" x="20" y="162.6953"></rect><rect fill="none" height="104.5313" style="stroke:#000000;stroke-width:1.5;" width="758" x="20" y="431.7578"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="104" x2="104" y1="36.2969" y2="553.2891"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="288" x2="288" y1="36.2969" y2="553.2891"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="488" x2="488" y1="36.2969" y2="553.2891"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="561" x2="561" y1="36.2969" y2="553.2891"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="689" x2="689" y1="36.2969" y2="553.2891"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="30" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="37" y="24.9951">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="30" y="552.2891"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="37" y="572.2842">ScalarColumnWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="200" x="188" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="195" y="24.9951">TypedZoneMapIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="200" x="188" y="552.2891"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="186" x="195" y="572.2842">TypedZoneMapIndexWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="465" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="472" y="24.9951">Field</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="46" x="465" y="552.2891"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="472" y="572.2842">Field</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="521" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="528" y="24.9951">ZoneMap</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="521" y="552.2891"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="528" y="572.2842">ZoneMap</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="157" x="611" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="618" y="24.9951">ColumnIndexMetaPB</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="157" x="611" y="552.2891"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="618" y="572.2842">ColumnIndexMetaPB</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="788" x="0" y="66.8633"></rect><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="788" y1="66.8633" y2="66.8633"></line><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="788" y1="69.8633" y2="69.8633"></line><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="55" x="366.5" y="56.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="36" x="372.5" y="72.3638">flush</text><line style="stroke:#181818;stroke-width:1.0;" x1="104" x2="146" y1="110.5625" y2="110.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="146" x2="146" y1="110.5625" y2="123.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="105" x2="146" y1="123.5625" y2="123.5625"></line><polygon fill="#181818" points="115,119.5625,105,123.5625,115,127.5625,111,123.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="111" y="105.4966">finish_current_page</text><path d="M10,138.5625 L74,138.5625 L74,145.6953 L64,155.6953 L10,155.6953 L10,138.5625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="193.9297" style="stroke:#000000;stroke-width:1.5;" width="601" x="10" y="138.5625"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="151.6294">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="121" x="89" y="150.7729">[if need zone map]</text><path d="M20,162.6953 L84,162.6953 L84,169.8281 L74,179.8281 L20,179.8281 L20,162.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1.5;" width="379" x="20" y="162.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="35" y="175.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="295" x="99" y="174.9058">[如果当前page行数 &lt; zone_map_row_num_threshold]</text><polygon fill="#181818" points="276,196.9609,286,200.9609,276,204.9609,280,200.9609" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="104" x2="282" y1="200.9609" y2="200.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="111" y="195.895">reset_page_zone_map</text><polygon fill="#181818" points="276,233.0938,286,237.0938,276,241.0938,280,237.0938" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="104" x2="282" y1="237.0938" y2="237.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="111" y="232.0278">flush()</text><polygon fill="#181818" points="476,262.2266,486,266.2266,476,270.2266,480,266.2266" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="288" x2="482" y1="266.2266" y2="266.2266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="295" y="261.1606">Update segment zone map</text><polygon fill="#181818" points="549,291.3594,559,295.3594,549,299.3594,553,295.3594" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="288" x2="555" y1="295.3594" y2="295.3594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="295" y="290.2935">store page zone map</text><polygon fill="#181818" points="299,320.4922,289,324.4922,299,328.4922,295,324.4922" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="293" x2="560" y1="324.4922" y2="324.4922"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="305" y="319.4263">zone map to string</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="788" x="0" y="360.0586"></rect><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="788" y1="360.0586" y2="360.0586"></line><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="788" y1="363.0586" y2="363.0586"></line><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="59" x="364.5" y="349.4922"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="40" x="370.5" y="365.5591">finish</text><line style="stroke:#181818;stroke-width:1.0;" x1="104" x2="146" y1="403.7578" y2="403.7578"></line><line style="stroke:#181818;stroke-width:1.0;" x1="146" x2="146" y1="403.7578" y2="416.7578"></line><line style="stroke:#181818;stroke-width:1.0;" x1="105" x2="146" y1="416.7578" y2="416.7578"></line><polygon fill="#181818" points="115,412.7578,105,416.7578,115,420.7578,111,416.7578" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="111" y="398.6919">write_zone_map</text><path d="M20,431.7578 L84,431.7578 L84,438.8906 L74,448.8906 L20,448.8906 L20,431.7578 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="104.5313" style="stroke:#000000;stroke-width:1.5;" width="758" x="20" y="431.7578"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="35" y="444.8247">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="121" x="99" y="443.9683">[if need zone map]</text><polygon fill="#181818" points="276,466.0234,286,470.0234,276,474.0234,280,470.0234" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="104" x2="282" y1="470.0234" y2="470.0234"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="111" y="464.9575">finish()</text><polygon fill="#181818" points="677.5,495.1563,687.5,499.1563,677.5,503.1563,681.5,499.1563" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="288" x2="683.5" y1="499.1563" y2="499.1563"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="295" y="494.0903">write segment zone map</text><polygon fill="#181818" points="677.5,524.2891,687.5,528.2891,677.5,532.2891,681.5,528.2891" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="288" x2="683.5" y1="528.2891" y2="528.2891"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="295" y="523.2231">write page zone map</text><!--SRC=[bP71IiGm48RlVOevwg4lK3OU50GF2uAx25v2s4pRG9g4D6NLepT1J-9D12-UVG4VfukFOPAsh8jMjdC9JER_-ESVGY2NJLq28Sd5YabcJxHiAdLfXKCBwH7yxcQG2oNgaguQQr4vQbY12PCEH0uAaSEjLWWLCmdu2X_j-ztczQNzV6hl7yFqrzl3vla3Pd6I-abgzPggfgAkj5YNMlAe3VMNBUzhSMEGNtdvd9apnV5wCEVrs7cY0psoK7NCQJp8OZu7Xr4xDXG0S2fGSiXWQJXp23KMbKzdDup_07tR4sgdBK9OOJ_rB4r_g0S9EEr9LgWY2RidXFI7ctRiTNYtKOxUUNAkqSiUmNR8s9sZO-V7q9kQ7l4uQZTidzSt]--></g></svg></p><h4 id="索引读取-1">索引读取 </h4>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="263px" preserveAspectRatio="none" style="width:630px;height:263px;background:#FFFFFF;" version="1.1" viewBox="0 0 630 263" width="630px" zoomAndPan="magnify"><defs></defs><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="63" x2="63" y1="36.2969" y2="227.9609"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="236" x2="236" y1="36.2969" y2="227.9609"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="416" x2="416" y1="36.2969" y2="227.9609"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="574.5" x2="574.5" y1="36.2969" y2="227.9609"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="24.9951">ColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="5" y="226.9609"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="12" y="246.9561">ColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="167" x="153" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153" x="160" y="24.9951">ZoneMapIndexReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="167" x="153" y="226.9609"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153" x="160" y="246.9561">ZoneMapIndexReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="172" x="330" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="158" x="337" y="24.9951">IndexedColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="172" x="330" y="226.9609"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="158" x="337" y="246.9561">IndexedColumnReader</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="525.5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="532.5" y="24.9951">ZoneMapPB</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="525.5" y="226.9609"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="532.5" y="246.9561">ZoneMapPB</text><line style="stroke:#181818;stroke-width:1.0;" x1="63.5" x2="105.5" y1="67.4297" y2="67.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="105.5" x2="105.5" y1="67.4297" y2="80.4297"></line><line style="stroke:#181818;stroke-width:1.0;" x1="64.5" x2="105.5" y1="80.4297" y2="80.4297"></line><polygon fill="#181818" points="74.5,76.4297,64.5,80.4297,74.5,84.4297,70.5,80.4297" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="70.5" y="62.3638">_load_zone_map_index()</text><polygon fill="#181818" points="224.5,105.5625,234.5,109.5625,224.5,113.5625,228.5,109.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="63.5" x2="230.5" y1="109.5625" y2="109.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="37" x="70.5" y="104.4966">load()</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="236.5" x2="278.5" y1="138.6953" y2="138.6953"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="278.5" x2="278.5" y1="138.6953" y2="151.6953"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="237.5" x2="278.5" y1="151.6953" y2="151.6953"></line><polygon fill="#181818" points="247.5,147.6953,237.5,151.6953,247.5,155.6953,243.5,151.6953" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="243.5" y="133.6294">_load()</text><polygon fill="#181818" points="404,176.8281,414,180.8281,404,184.8281,408,180.8281" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="236.5" x2="410" y1="180.8281" y2="180.8281"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="243.5" y="175.7622">read zone map from file</text><polygon fill="#181818" points="563,205.9609,573,209.9609,563,213.9609,567,209.9609" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="416" x2="569" y1="209.9609" y2="209.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="423" y="204.895">parse to ZoneMapPB</text><!--SRC=[SyxFAStD2qfDJ4ajKj2rKt16ubifnEVa9wR4L-NdfSRd9XR4P-Qbf5PeQ78vesW2wee2gl1DBF04oSFqWhG2rM9AuT2X0BKEjnumFpK5rOb5G5e1v485e0iLqehoSnNICdDIkR0eHhOumCbAeI2ng3XLeIGV8GO0]--></g></svg></p><h4 id="索引使用-1">索引使用 </h4>
<p>zone map 过滤原理简单概括就是使用sql中的过滤条件与zone map中的信息进行判断。<br>
例如：过滤条件为 field = value。如果 value在Zone Map索引的最大值与最小值之间，则Data Page不能被过滤掉。<br>
可以支持的过滤条件有 = 、&lt; 、&gt; 、&lt;= 、&gt;=、 is null、 is not null、 in</p>
<h3 id="前缀索引short-key-index">前缀索引（Short Key Index） </h3>
<h4 id="索引概述-2">索引概述 </h4>
<p>前缀索引是一种稀疏索引。数据刷写过程中，每写入一定的数据行（默认为 1024 行）就会生成一条前缀索引项。前缀索引会对每一个索引间隔的第一个数据行的前缀字段进行编码，前缀字段的编码与前缀字段的值具有相同的排序规则，即前缀字段的值排序越靠前，对应的编码值排序也越靠前。Segment 文件是按 Key 排序的，因此，前缀索引项也是按 Key 排序的。<br>
<img src="./image/image-13.png" alt="Alt text"></p>
<p><strong>前缀索引长度规则</strong><br>
将一行数据的前 36 个字节 作为这行数据的前缀索引。如果遇到VARCHAR，则进行截断，varchar最多保存20个字节。<br>
根据实际测试, 用于生成short key 的column数量上限是3.<br>
<img src="./image/image-15.png" alt="Alt text"></p>
<h4 id="索引生成-2">索引生成 </h4>
<p class="plantuml"><!--?xml version="1.0" encoding="us-ascii" standalone="no"?--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="525px" preserveAspectRatio="none" style="width:440px;height:525px;background:#FFFFFF;" version="1.1" viewBox="0 0 440 525" width="440px" zoomAndPan="magnify"><defs></defs><g><rect fill="#FFFFFF" height="146.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="73.5" y="118.5625"></rect><rect fill="#FFFFFF" height="134.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="73.5" y="337.3594"></rect><rect fill="none" height="59.2656" style="stroke:#000000;stroke-width:1.5;" width="287" x="10" y="138.5625"></rect><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1.5;" width="320" x="10" y="211.8281"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="78" x2="78" y1="36.2969" y2="489.8906"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="239" x2="239" y1="36.2969" y2="489.8906"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="379" x2="379" y1="36.2969" y2="489.8906"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="20" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="27" y="24.9951">SegmentWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="20" y="488.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="27" y="508.8857">SegmentWriter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="159" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="166" y="24.9951">ShortKeyIndexBuilder</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="159" y="488.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="166" y="508.8857">ShortKeyIndexBuilder</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98" x="330" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="337" y="24.9951">PagePointer</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98" x="330" y="488.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="337" y="508.8857">PagePointer</text><rect fill="#FFFFFF" height="146.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="73.5" y="118.5625"></rect><rect fill="#FFFFFF" height="134.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="73.5" y="337.3594"></rect><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="433" x="0" y="66.8633"></rect><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="433" y1="66.8633" y2="66.8633"></line><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="433" y1="69.8633" y2="69.8633"></line><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="76" x="178.5" y="56.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="57" x="184.5" y="72.3638">append</text><line style="stroke:#181818;stroke-width:1.0;" x1="78.5" x2="125.5" y1="105.5625" y2="105.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="125.5" y1="105.5625" y2="118.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="84.5" x2="125.5" y1="118.5625" y2="118.5625"></line><polygon fill="#181818" points="94.5,114.5625,84.5,118.5625,94.5,122.5625,90.5,118.5625" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="90.5" y="100.4966">append_block()</text><path d="M10,138.5625 L87,138.5625 L87,145.6953 L77,155.6953 L10,155.6953 L10,138.5625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="59.2656" style="stroke:#000000;stroke-width:1.5;" width="287" x="10" y="138.5625"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="25" y="151.6294">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="190" x="102" y="150.7729">[num_rows_per_block = 1024]</text><line style="stroke:#181818;stroke-width:1.0;" x1="83.5" x2="125.5" y1="176.8281" y2="176.8281"></line><line style="stroke:#181818;stroke-width:1.0;" x1="125.5" x2="125.5" y1="176.8281" y2="189.8281"></line><line style="stroke:#181818;stroke-width:1.0;" x1="84.5" x2="125.5" y1="189.8281" y2="189.8281"></line><polygon fill="#181818" points="94.5,185.8281,84.5,189.8281,94.5,193.8281,90.5,189.8281" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="90.5" y="171.7622">store short_key_pos</text><path d="M10,211.8281 L87,211.8281 L87,218.9609 L77,228.9609 L10,228.9609 L10,211.8281 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1.5;" width="320" x="10" y="211.8281"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="25" y="224.895">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="100" x="102" y="224.0386">[short_key_pos]</text><polygon fill="#181818" points="227.5,246.0938,237.5,250.0938,227.5,254.0938,231.5,250.0938" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;" x1="83.5" x2="233.5" y1="250.0938" y2="250.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="90.5" y="245.0278">add_item()</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="433" x="0" y="285.6602"></rect><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="433" y1="285.6602" y2="285.6602"></line><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="433" y1="288.6602" y2="288.6602"></line><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="72" x="180.5" y="275.0938"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="53" x="186.5" y="291.1606">finalize</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="78.5" x2="125.5" y1="324.3594" y2="324.3594"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="125.5" x2="125.5" y1="324.3594" y2="337.3594"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="84.5" x2="125.5" y1="337.3594" y2="337.3594"></line><polygon fill="#181818" points="94.5,333.3594,84.5,337.3594,94.5,341.3594,90.5,337.3594" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="90.5" y="319.2935">_write_short_key_index</text><polygon fill="#181818" points="227.5,367.4922,237.5,371.4922,227.5,375.4922,231.5,371.4922" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="83.5" x2="233.5" y1="371.4922" y2="371.4922"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54" x="90.5" y="366.4263">finalize()</text><polygon fill="#181818" points="94.5,396.625,84.5,400.625,94.5,404.625,90.5,400.625" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="88.5" x2="238.5" y1="400.625" y2="400.625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="100.5" y="395.5591">data &amp; page footer</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="83.5" x2="125.5" y1="429.7578" y2="429.7578"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="125.5" x2="125.5" y1="429.7578" y2="442.7578"></line><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="84.5" x2="125.5" y1="442.7578" y2="442.7578"></line><polygon fill="#181818" points="94.5,438.7578,84.5,442.7578,94.5,446.7578,90.5,442.7578" style="stroke:#181818;stroke-width:1.0;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="90.5" y="424.6919">PageIO::write_page</text><polygon fill="#181818" points="367,467.8906,377,471.8906,367,475.8906,371,471.8906" style="stroke:#181818;stroke-width:1.0;"></polygon><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="78.5" x2="373" y1="471.8906" y2="471.8906"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="85.5" y="466.8247">store page point</text><!--SRC=[VL4zRy8m4DtzAswgw12fHKmMPc1334LYOBGCFi0YyLcEGqf_VMrIjKrhuyawlQzx9mGevz1g489jyTIW3Jjl0dge5Z0Qy2-atDTqk4oUcJe4SrK1np1M4pcmNICzzQrqw0S227XzcSuOnFVO23YqWJn2UoOVv0Llqb7BeZKRnCVpl622hF6siXhVbvsfzLrNQIqZf8dfavp6mWvC23WQgshpWPbc_bSZ-_IHFybCCYvLb97BvENV4MBSCMLULGMALa714pXrGZWI5Tp-rBs9wDKRvyCIYPiX9T26ZFrzeRkDIyDYbvy0]--></g></svg></p><h4 id="索引读取-2">索引读取 </h4>
<p>数据查询时，会打开Segment文件，从footer中获取Short Key Page的offset以及大小，然后从Segment文件中读取Short Key Page中的索引数据，并解析出每一条前缀索引项。</p>
<h4 id="索引使用-2">索引使用 </h4>
<p>如果查询过滤条件包含前缀字段时，就可以使用前缀索引进行快速地行过滤。查询过滤条件会被划分成多个KeyRange。<br>
例如user_id列为前缀索引列</p>
<pre data-role="codeBlock" data-info="" class="language-text text"><code>select * from example_tbl where user_id&gt;10000 and user_id&lt;10002;
</code></pre><p>keyrange为(10000,10002)对一个keyrange<br>
<img src="./image/image-18.png" alt="Alt text"><br>
进行行过滤的方法如下：</p>
<ul>
<li>
<p>寻找keyrange上界对应的upper_row_id</p>
<ul>
<li>
<p>对Key Range上界的前缀字段key进行编码。</p>
</li>
<li>
<p>寻找key可能存在的范围下界start。根据编码寻找前缀索引中第一个等于（存在前缀索引项与key的编码相同）或大于（不存在前缀索引项的与key的编码相同）key编码的前缀索引项。如果找到满足条件的索引项，并且该索引项不是第一条前缀索引项，则将该索引项的前一条前缀索引项对应的行号记录为start（前缀索引是稀疏索引，第一个等于或大于Key Range上界key的数据行有可能在前一条前缀索引项对应的数据行之后）；如果找到满足条件的索引项，并且该索引项是第一条前缀索引项，则记录该索引项对应的行号为start。如果没有找到一条前缀索引项等于或大于key的编码，则记录最后一条前缀索引项对应的行号为start（第一个等于或大于key的行有可能在最后一条前缀索引项之后）。</p>
</li>
<li>
<p>寻找key可能存在的范围上界end。根据编码寻找前缀索引中第一个大于key的二进制编码的索引项。如果找到满足条件的索引项，则记录该索引项对应的行号为end；如果没有找到一条前缀索引项大于key的编码，则记录Segment最后一行的行号为end。</p>
</li>
<li>
<p>使用二分查找算法在start与end之间的行范围内寻找第一个大于key的编码的行，行号记为upper rowid。</p>
</li>
</ul>
</li>
<li>
<p>根据二分法确定上界的行号，mid=(start+end)/2;根据mid找到mid所在的page，获取mid对应的值与上界值比较，直至找到上界值对应的upper_row_id;</p>
</li>
<li>
<p>下界值同样根据步骤获取lower_row_id，则根据前缀索引过滤出有效行数为lower_row_id~upper_row_id，为_row_bitmap</p>
</li>
</ul>
<h3 id="bitmap-索引">Bitmap 索引 </h3>
<pre class="language-text">TODO
</pre>
<h3 id="bloom-filter-索引">Bloom Filter 索引 </h3>
<pre class="language-text">TODO
</pre>
<h3 id="倒排索引inverted-index">倒排索引（inverted index） </h3>
<pre class="language-text">TODO
</pre>
<h2 id="参考资料">参考资料 </h2>
<ul>
<li><a href="https://www.modb.pro/db/111345">深度解析｜Apache Doris 索引机制解析</a></li>
<li><a href="https://cirrodata.feishu.cn/docx/H7WOd6nD7ocDk0xUVU1cFQdDn5d">【Doris 全面解析】存储层设计介绍 1——存储结构设计解析</a></li>
<li><a href="https://cirrodata.feishu.cn/docx/IxS3dXy7Lo7kGrxkDNncq1Q9n4d">Doris中的索引机制</a></li>
<li><a href="https://cirrodata.feishu.cn/file/Bx3QboWDpo6ynXxoRTucPWFwn6b">doris-RowsetReader介绍</a></li>
</ul>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>